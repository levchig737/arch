GAS LISTING task3.S 			page 1


   1              	/*
   2              	 * –ü—Ä–æ–≥—Ä–∞–º–º–∞ –≤–≤–æ–¥–∞ –∫–æ–¥–æ–≤ —Ü–∏—Ñ—Ä–æ–≤—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –≤ –±—É—Ñ–µ—Ä –≤ –û–ü
   3              	 */
   4              	
   5              	.include "my-macro"
   1              	/*
   2              	 * –ú–∞–∫—Ä–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã.
   3              	 * –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
   4              	 *     - –∫–æ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã
   5              	 *
   6              	 * –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–∞–∫—Ä–æ–≤—ã–∑–æ–≤–∞ –∏–∑–º–µ–Ω—è—é—Ç—Å—è —Ä–µ–≥–∏—Å—Ç—Ä—ã: %e
   7              	 * –°–º. —Ç–∞–∫–∂–µ 'man 2 exit'
   8              	*/
   9              	.macro Exit ret_val
  10              	    movl $1, %eax         # –Ω–æ–º–µ—Ä —Å–∏—Å—Ç. –≤—ã–∑–æ–≤–∞ exit
  11              	    movl \ret_val, %ebx     # –∫–æ–¥ –≤—ã—Ö–æ–¥–∞
  12              	    int $0x80         # –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –≤—ã–∑–æ–≤
  13              	.endm
  14              	
  15              	
  16              	/*
  17              	 * –ú–∞–∫—Ä–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–ª—è —Å—á–∏—Ç—ã–≤–∞–Ω–∏—è –æ–¥–Ω–æ–≥–æ –±–∞–π—Ç–∞ –∫–æ–¥–∞ —Å
  18              	 * —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –≤–≤–æ–¥–∞
  19              	 * –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
  20              	 *     - –∞–¥—Ä–µ—Å –±—É—Ñ–µ—Ä–∞ –¥–ª—è —Å—á–∏—Ç—ã–≤–∞–Ω–∏—è –±–∞–π—Ç–∞
  21              	 * –†–µ–∑—É–ª—å—Ç–∞—Ç:
  22              	 *    - –≤ %eax –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—á–∏—Ç–∞–Ω–Ω—ã—Ö –±–∞–π—Ç–æ–≤
  23              	 *    - –ø–æ –∞–¥—Ä–µ—Å—É buf_addr - —Å—á–∏—Ç–∞–Ω–Ω—ã–π –±–∞–π—Ç
  24              	 *
  25              	 * –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–∞–∫—Ä–æ–≤—ã–∑–æ–≤–∞ –∏–∑–º–µ–Ω—è—é—Ç—Å—è —Ä–µ–≥–∏—Å—Ç—Ä—ã: %e
  26              	 * –°–º. —Ç–∞–∫–∂–µ 'man 2 read'
  27              	*/
  28              	.macro Getchar buf_addr
  29              	    movl $3, %eax        # –Ω–æ–º–µ—Ä —Å–∏—Å—Ç. –≤—ã–∑–æ–≤–∞ read
  30              	    movl $0, %ebx        # –ø–∞—Ä–∞–º–µ—Ç—Ä 1: –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –≤–≤–æ
  31              	    movl \buf_addr, %ecx    # –ø–∞—Ä–∞–º–µ—Ç—Ä 2: –∞–¥—Ä–µ—Å –±—É—Ñ–µ—Ä–∞ (–æ–Ω –∂–µ - —Ñ–∞–∫—Ç–∏—á
  32              	                     # –ø–∞—Ä–∞–º–µ—Ç—Ä –º–∞–∫—Ä–æ–≤—ã–∑–æ–≤–∞)
  33              	    movl $1, %edx        # –ø–∞—Ä–∞–º–µ—Ç—Ä 3: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–π—Ç–æ–≤ –¥–ª—è —á—Ç–µ–Ω–∏—
  34              	    int $0x80        # –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –≤—ã–∑–æ–≤
  35              	.endm
  36              	
  37              	/*
  38              	 * –ú–∞–∫—Ä–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–ª—è  –≤—ã–≤–æ–¥–∞ —Å—Ç—Ä–æ–∫–∏ –≤ —Ñ–∞–π–ª —Å—Ç–∞–Ω–¥–∞—Ä—Ç–
  39              	 * –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
  40              	 *     - –°—Ç—Ä–æ–∫–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞.
  41              	 *
  42              	 * –ü—Ä–∏–º–µ—Ç—Ä –º–∞–∫—Ä–æ–≤—ã–∑–æ–≤–∞:
  43              	 *    Puts "–¢–µ–∫—Å—Ç –≤—ã–≤–æ–¥–∏–º–æ–π —Å—Ç—Ä–æ–∫–∏"
  44              	 *
  45              	 * –†–µ–∑—É–ª—å—Ç–∞—Ç:
  46              	 *    - –≤—ã–≤–æ–¥–∏—Ç –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤—ã–≤–æ–¥ —Å–∏–º–≤–æ–ª—ã –∑–∞–¥–∞–Ω–Ω–æ–π —Å—Ç—Ä–
  47              	 *      –∏ –≤—Å–ª–µ–¥ –∑–∞ –Ω–∏–º–∏ —Å–∏–º–≤–æ–ª –ø–µ—Ä–µ–≤–æ–¥–∞ —Å—Ç—Ä–æ–∫–∏ \n
  48              	 *
  49              	 * –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–∞–∫—Ä–æ–≤—ã–∑–æ–≤–∞ –∏–∑–º–µ–Ω—è—é—Ç—Å—è —Ä–µ–≥–∏—Å—Ç—Ä—ã: %e
  50              	 * –°–º. —Ç–∞–∫–∂–µ 'man puts', 'man 2 write'
  51              	*/
  52              	.macro Puts string
GAS LISTING task3.S 			page 2


  53              	.data
  54              	    str\@:     .ascii "\string\n"  # —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π —Å—Ç—Ä–æ–∫–∏ –
  55              	
  56              	    strlen\@ =     . - str\@           # –ø–æ–ª—É—á–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª–∏–Ω—ã —Å—Ç—Ä–æ–∫–
  57              	
  58              	.text
  59              	    movl $4, %eax        # –Ω–æ–º–µ—Ä —Å–∏—Å—Ç. –≤—ã–∑–æ–≤–∞ write
  60              	    movl $1, %ebx        # –ø–∞—Ä–∞–º–µ—Ç—Ä 1: –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –≤—ã–≤
  61              	    movl $str\@, %ecx    # –ø–∞—Ä–∞–º–µ—Ç—Ä 2: –∞–¥—Ä–µ—Å –ø–∞–º—è—Ç–∏ —Å –≤—ã–≤–æ–¥–∏–º—ã–º–∏ —Å–∏
  62              	    movl $strlen\@, %edx     # –ø–∞—Ä–∞–º–µ—Ç—Ä 3: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–π—Ç–æ–≤ –¥–ª—è –≤—ã–≤–
  63              	    int $0x80        # –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –≤—ã–∑–æ–≤
  64              	.endm
   6              	
   7              	.bss
   8              	    .lcomm buf, 100 # 100 –±–∞–π—Ç–æ–≤—ã–π –±—É—Ñ–µ—Ä –¥–ª—è –∫–æ–¥–æ–≤ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–∏
   9              	    .lcomm c, 1    # –æ–¥–Ω–æ–±–∞–π—Ç–æ–≤—ã–π –±—É—Ñ–µ—Ä –¥–ª—è —á—Ç–µ–Ω–∏—è –±–∞–π—Ç–∞ –∏–∑ —Ñ–∞–π
  10              	
  11              	.text
  12              	.global _start
  13              	
  14              	_start:
  15 0000 29F6     	    sub    %esi, %esi     # —É–∫–∞–∑–∞—Ç–µ–ª—å –∞–¥—Ä–µ—Å–∞ –±–∞–π—Ç–∞ –≤ –±—É—Ñ–µ—Ä–µ buf (–∏–Ω–¥–
  16              	
  17              	show_prompt:
  18              	    Puts "–í–≤–æ–¥–∏—Ç–µ —Ü–∏—Ñ—Ä—É, –¥—Ä—É–≥ –º–æ–π!"     # –º–∞–∫—Ä–æ–≤—ã–∑–æ–≤ –≤—ã–≤–æ–¥–∞ —Å—Ç
  18              	> .data
  18 0000 D092D0B2 	>  str0:.ascii "–í–≤–æ–¥–∏—Ç–µ —Ü–∏—Ñ—Ä—É, –¥—Ä—É–≥ –º–æ–π!\n"
  18      D0BED0B4 
  18      D0B8D182 
  18      D0B520D1 
  18      86D0B8D1 
  18              	> 
  18              	>  strlen0 =. - str0
  18              	> 
  18              	> .text
  18 0002 B8040000 	>  movl $4,%eax
  18      00
  18 0007 BB010000 	>  movl $1,%ebx
  18      00
  18 000c B9000000 	>  movl $str0,%ecx
  18      00
  18 0011 BA2C0000 	>  movl $strlen0,%edx
  18      00
  18 0016 CD80     	>  int $0x80
  19              	                    # —Ñ–∞–π–ª stdout (–ø–æ–¥—Å–∫–∞–∑–∫–∞ –≤–≤–æ–¥–∞)
  20              	
  21              	kbd_input:
  22              	    Getchar $c          # –º–∞–∫—Ä–æ–≤—ã–∑–æ–≤ –≤–≤–æ–¥–∞ –±–∞–π—Ç–∞ –∏–∑ stdin –≤
  22 0018 B8030000 	>  movl $3,%eax
  22      00
  22 001d BB000000 	>  movl $0,%ebx
  22      00
  22 0022 B9640000 	>  movl $c,%ecx
  22      00
  22              	>  
  22 0027 BA010000 	>  movl $1,%edx
  22      00
GAS LISTING task3.S 			page 3


  22 002c CD80     	>  int $0x80
  23              	            # –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π –±—É—Ñ–µ—Ä c
  24              	
  25 002e 83F800   	    cmpl $0, %eax     # –Ω–∞—Å—Ç—É–ø–∏–ª–æ —Å–æ–±—ã—Ç–∏–µ EOF (–∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞ stdin) ?
  26 0031 0F849000 	    je stop        # –î–∞ - –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã
  26      0000
  27              	
  28 0037 803D6400 	    cmpb $'\n', c     # —ç—Ç–æ —Å–∏–º–≤–æ–ª –ø–µ—Ä–µ–≤–æ–¥–∞ —Å—Ç—Ä–æ–∫–∏ ?
  28      00000A
  29 003e 7456     	    je eax_input      # –î–ê - –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–∏–º–≤–æ–ª –≤ eax
  30 0040 803D6400 	    cmpb $'9', c      # –∫–æ–¥ –±–æ–ª—å—à–µ –∫–æ–¥–∞ —Å–∏–º–≤–æ–ª–∞ '9' ?
  30      000039
  31 0047 7732     	    ja print_err_msg    # –î–ê - –Ω–∞ –≤—ã–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
  32 0049 803D6400 	    cmpb $'0', c    # –∫–æ–¥ –º–µ–Ω—å—à–µ –∫–æ–¥–∞ —Å–∏–º–≤–æ–ª–∞ '0' ?
  32      000030
  33 0050 7229     	    jb print_err_msg    # –î–ê - –Ω–∞ –≤—ã–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
  34              		
  35 0052 A0640000 	    movb c, %al         # –ø–µ—Ä–µ–¥–∞—Ç—å –∫–æ–¥ —Å–∏–º–≤–æ–ª–∞ —Ü–∏—Ñ—Ä—ã –∏–∑ c –≤ al
  35      00
  36              	
  37 0057 83FE64   	    cmpl $100, %esi	# —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º esi —Å 100
  38 005a 7453     	    je print_end_buffer	# –ï—Å–ª–∏ –≤–µ—Ä–Ω–æ —Ç–æ –≤—ã–≤–æ–¥ –æ—à–∏–±–∫–∏ –æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ 
  39              		
  40 005c 88860000 	    movb %al, buf(%esi) # –ø–µ—Ä–µ–¥–∞—Ç—å –∫–æ–¥ —Å–∏–º–≤–æ–ª–∞ —Ü–∏—Ñ—Ä—ã –∏–∑ al –≤ –±–∞–π—Ç
  40      0000
  41              	            # –±—É—Ñ–µ—Ä–∞ –ø–æ –∞–¥—Ä–µ—Å—É &buf + esi
  42 0062 46       	    incl %esi        # —É–∫–∞–∑–∞—Ç—å –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –±–∞–π—Ç –±—É—Ñ–µ—Ä–∞ –¥–ª—è
  43              	            # —Å–ª–µ–¥—É—é—â–µ–≥–æ –∫–æ–¥–∞
  44              	
  45              	    Puts "–¶–∏—Ñ—Ä–∞! –•–æ—Ä–æ—à–æ." # —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± —É—Å–ø–µ—Ö–µ –≤–≤–æ–¥–µ
  45              	> .data
  45 002c D0A6D0B8 	>  str2:.ascii "–¶–∏—Ñ—Ä–∞! –•–æ—Ä–æ—à–æ.\n"
  45      D184D180 
  45      D0B02120 
  45      D0A5D0BE 
  45      D180D0BE 
  45              	> 
  45              	>  strlen2 =. - str2
  45              	> 
  45              	> .text
  45 0063 B8040000 	>  movl $4,%eax
  45      00
  45 0068 BB010000 	>  movl $1,%ebx
  45      00
  45 006d B92C0000 	>  movl $str2,%ecx
  45      00
  45 0072 BA1A0000 	>  movl $strlen2,%edx
  45      00
  45 0077 CD80     	>  int $0x80
  46              	
  47 0079 EB87     	    jmp show_prompt    # –Ω–∞ –≤–≤–æ–¥ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–∏–º–≤–æ–ª–∞2
  48              	
  49              	print_err_msg:
  50              	    Puts "–ù–µ —Ü–∏—Ñ—Ä–æ–≤–∞—è –∫–ª–∞–≤–∏—à–∞. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –≤–≤–æ–¥"    # –≤—ã–≤–æ–¥ —Å–æ–æ
  50              	> .data
  50 0046 D09DD0B5 	>  str3:.ascii "–ù–µ —Ü–∏—Ñ—Ä–æ–≤–∞—è –∫–ª–∞–≤–∏—à–∞. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –≤–≤–æ–¥\n"
  50      20D186D0 
GAS LISTING task3.S 			page 4


  50      B8D184D1 
  50      80D0BED0 
  50      B2D0B0D1 
  50              	> 
  50              	>  strlen3 =. - str3
  50              	> 
  50              	> .text
  50 007b B8040000 	>  movl $4,%eax
  50      00
  50 0080 BB010000 	>  movl $1,%ebx
  50      00
  50 0085 B9460000 	>  movl $str3,%ecx
  50      00
  50 008a BA420000 	>  movl $strlen3,%edx
  50      00
  50 008f CD80     	>  int $0x80
  51 0091 E96CFFFF 	    jmp show_prompt     # –Ω–∞ –≤–≤–æ–¥ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–∏–º–≤–æ–ª–∞
  51      FF
  52              	
  53              	eax_input:
  54 0096 89F3     	    movl %esi,%ebx 	# –ö–æ–ø–∏—Ä—É–µ–º %esi –≤ %ebx
  55 0098 4B       	    decl %ebx		# –£–º–µ–Ω—å—à–∞–µ–º %ebx –Ω–∞ 1
  56 0099 83FB00   	    cmpl $0, %ebx 	# –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º %ebx —Å 0
  57 009c 0F8C76FF 	    jl kbd_input 	# < - –ø–µ—Ä–µ—Ö–æ–¥ –∫ –Ω–∞—á–∞–ª—É –ø—Ä–æ–≥—Ä–∞–º–º—ã –¥–ª—è –≤–≤–æ–¥–∞ —Å–ª–µ–
  57      FFFF
  58 00a2 8A830000 	    movb buf(%ebx), %al	# –ö–æ–ø–∏—Ä—É–µ–º —è—á–µ–π–∫—É buf + %ebx –≤ %al
  58      0000
  59 00a8 2C30     	    subb $48, %al	# –û—Ç–Ω–∏–º–∞–µ–º 48 –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —á–∏—Å–ª–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏
  60 00aa E969FFFF 	    jmp kbd_input	# –ü–µ—Ä–µ—Ö–æ–¥ –∫ –Ω–∞—á–∞–ª—É –ø—Ä–æ–≥—Ä–∞–º–º—ã
  60      FF
  61              	
  62              	print_end_buffer:
  63              	    Puts "–ë—É—Ñ—Ñ–µ—Ä –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω" # –í—ã–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
  63              	> .data
  63 0088 D091D183 	>  str4:.ascii "–ë—É—Ñ—Ñ–µ—Ä –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω\n"
  63      D184D184 
  63      D0B5D180 
  63      20D0BFD0 
  63      B5D180D0 
  63              	> 
  63              	>  strlen4 =. - str4
  63              	> 
  63              	> .text
  63 00af B8040000 	>  movl $4,%eax
  63      00
  63 00b4 BB010000 	>  movl $1,%ebx
  63      00
  63 00b9 B9880000 	>  movl $str4,%ecx
  63      00
  63 00be BA220000 	>  movl $strlen4,%edx
  63      00
  63 00c3 CD80     	>  int $0x80
  64 00c5 EB00     	    jmp stop		# –≤—ã—Ö–æ–¥ –∏–∑ –ø—Ä–æ–≥—Ä–∞–º–º—ã	
  65              	
  66              	
  67              	stop:
  68              	    Exit $0
GAS LISTING task3.S 			page 5


  68 00c7 B8010000 	>  movl $1,%eax
  68      00
  68 00cc BB000000 	>  movl $0,%ebx
  68      00
  68 00d1 CD80     	>  int $0x80
  69              	
  70              	.end
GAS LISTING task3.S 			page 6


DEFINED SYMBOLS
             task3.S:8      .bss:0000000000000000 buf
             task3.S:8      .bss:0000000000000064 c
             task3.S:14     .text:0000000000000000 _start
             task3.S:17     .text:0000000000000002 show_prompt
             task3.S:18     .data:0000000000000000 str0
             task3.S:18     *ABS*:000000000000002c strlen0
             task3.S:21     .text:0000000000000018 kbd_input
             task3.S:67     .text:00000000000000c7 stop
             task3.S:53     .text:0000000000000096 eax_input
             task3.S:49     .text:000000000000007b print_err_msg
             task3.S:62     .text:00000000000000af print_end_buffer
             task3.S:45     .data:000000000000002c str2
             task3.S:45     *ABS*:000000000000001a strlen2
             task3.S:50     .data:0000000000000046 str3
             task3.S:50     *ABS*:0000000000000042 strlen3
             task3.S:63     .data:0000000000000088 str4
             task3.S:63     *ABS*:0000000000000022 strlen4

NO UNDEFINED SYMBOLS
